<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Self Growth App</title>

<style>
body{margin:0;font-family:system-ui;background:#f4f6fb}
.screen{display:none;max-width:480px;margin:auto;padding:16px}
.active{display:block}
button,input,select{width:100%;padding:12px;margin-top:10px;font-size:16px}
.card{background:#fff;padding:12px;border-radius:10px;margin-top:10px}
.bar{height:14px;background:#ddd;border-radius:8px;overflow:hidden}
.bar-inner{height:100%;background:#4caf50;width:0%}
.small{font-size:14px;color:#555}

#timerScreen{
  position:fixed;inset:0;
  background:#000;color:#0f0;
  display:none;flex-direction:column;
  justify-content:center;align-items:center;
  z-index:9999
}
#timerScreen.active{display:flex}
#timerTime{font-size:64px}

.legend{display:flex;flex-wrap:wrap;margin-top:10px}
.legend span{display:flex;align-items:center;margin-right:10px;font-size:12px}
.legend i{width:12px;height:12px;display:inline-block;margin-right:4px;border-radius:3px}
</style>
</head>

<body>

<!-- ãƒ›ãƒ¼ãƒ  -->
<div id="home" class="screen active">
  <h1>è‚²æˆãƒ›ãƒ¼ãƒ </h1>

  <div class="card">
    Lv <span id="level"></span>
    <div class="bar"><div class="bar-inner" id="expBar"></div></div>
    <div class="small">æ¬¡ã¾ã§ã‚ã¨ <span id="nextExp"></span> EXP</div>
  </div>

  <button onclick="startTimer()">â–¶ ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹</button>
  <button onclick="showScreen('manual')">ğŸ“ æ‰‹å‹•è¨˜éŒ²</button>
  <button onclick="showScreen('graph')">ğŸ“ˆ ã‚°ãƒ©ãƒ•</button>
</div>

<!-- ã‚¿ã‚¤ãƒãƒ¼ -->
<div id="timerScreen">
  <div id="timerTime">0:00</div>
  <button onclick="stopTimer()">STOP</button>
</div>

<!-- æ‰‹å‹•è¨˜éŒ² -->
<div id="manual" class="screen">
  <h1>æ‰‹å‹•è¨˜éŒ²</h1>
  <input id="goalInput" placeholder="ç›®æ¨™ï¼ˆä¾‹ï¼šè‹±èªãƒ»æ•°å­¦ï¼‰">
  <input id="manualHour" type="number" placeholder="æ™‚é–“">
  <input id="manualMin" type="number" placeholder="åˆ†">
  <button onclick="saveManual()">ä¿å­˜</button>
  <button onclick="showScreen('home')">æˆ»ã‚‹</button>
</div>

<!-- ã‚°ãƒ©ãƒ• -->
<div id="graph" class="screen">
  <h1>å­¦ç¿’ã‚°ãƒ©ãƒ•</h1>

  <select id="graphMode" onchange="drawGraph()">
    <option value="day">æ—¥åˆ¥ï¼ˆ7æ—¥ï¼‰</option>
    <option value="month">æœˆåˆ¥ï¼ˆ6ã‹æœˆï¼‰</option>
  </select>

  <canvas id="chart" width="340" height="220"></canvas>
  <div class="legend" id="legend"></div>
  <button onclick="showScreen('home')">æˆ»ã‚‹</button>
</div>

<script>
/* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
const data = JSON.parse(localStorage.getItem('growth')) || {
  exp:0, level:1,
  logs:{},   // logs[day][goal] = minutes
  maxStreak:0
};
function save(){localStorage.setItem('growth',JSON.stringify(data))}

/* ===== ç”»é¢ ===== */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='home') renderHome();
  if(id==='graph') drawGraph();
}

/* ===== ãƒ¬ãƒ™ãƒ« ===== */
function needExp(lv){return 100*lv*lv}
function updateLevel(){
  while(data.exp>=needExp(data.level)){
    data.exp-=needExp(data.level);
    data.level++;
  }
}

/* ===== ã‚¿ã‚¤ãƒãƒ¼ ===== */
let sec=0,timer=null,running=false;
function startTimer(){
  if(running)return;
  running=true;sec=0;
  timerScreen.classList.add('active');
  timer=setInterval(()=>{
    sec++;
    timerTime.textContent =
      Math.floor(sec/60)+':'+String(sec%60).padStart(2,'0');
  },1000);
}
function stopTimer(){
  if(!running)return;
  clearInterval(timer);
  running=false;
  timerScreen.classList.remove('active');
  const goal=prompt('ç›®æ¨™åã‚’å…¥åŠ›');
  if(goal) saveMinutes(goal,Math.floor(sec/60));
  showScreen('home');
}

/* ===== æ‰‹å‹•ä¿å­˜ ===== */
function saveManual(){
  const g=goalInput.value.trim();
  const h=Number(manualHour.value)||0;
  const m=Number(manualMin.value)||0;
  if(!g || (h===0 && m===0)) return alert('å…¥åŠ›ã—ã¦ãã ã•ã„');
  saveMinutes(g,h*60+m);
  goalInput.value=manualHour.value=manualMin.value='';
  showScreen('home');
}

/* ===== å…±é€šä¿å­˜ ===== */
function saveMinutes(goal,min){
  const day=new Date().toISOString().slice(0,10);
  if(!data.logs[day]) data.logs[day]={};
  data.logs[day][goal]=(data.logs[day][goal]||0)+min;

  const streak=calcStreak();
  data.maxStreak=Math.max(data.maxStreak,streak);
  data.exp+=Math.floor(min*(1+streak*0.1));
  updateLevel();
  save();
}

/* ===== é€£ç¶š ===== */
function calcStreak(){
  const days=Object.keys(data.logs).sort().reverse();
  let streak=0,prev=new Date();
  for(const d of days){
    if((prev-new Date(d))/86400000<=1){
      streak++;prev=new Date(d);
    } else break;
  }
  return streak;
}

/* ===== è¡¨ç¤º ===== */
function renderHome(){
  level.textContent=data.level;
  nextExp.textContent=needExp(data.level)-data.exp;
  expBar.style.width=(data.exp/needExp(data.level)*100)+'%';
}

/* ===== ã‚°ãƒ©ãƒ• ===== */
const colors=[
  '#4caf50','#2196f3','#ff9800','#9c27b0',
  '#f44336','#009688','#795548'
];

function drawGraph(){
  const ctx=chart.getContext('2d');
  ctx.clearRect(0,0,340,220);

  const mode=document.getElementById('graphMode').value;

  // ç›®æ¨™ä¸€è¦§
  const goals=[...new Set(
    Object.values(data.logs).flatMap(d=>Object.keys(d))
  )];

  // å‡¡ä¾‹
  legend.innerHTML='';
  goals.forEach((g,i)=>{
    const s=document.createElement('span');
    s.innerHTML=`<i style="background:${colors[i%colors.length]}"></i>${g}`;
    legend.appendChild(s);
  });

  let labels=[], table={};

  if(mode==='day'){
    labels=[...Array(7)].map((_,i)=>{
      const d=new Date();d.setDate(d.getDate()-6+i);
      return d.toISOString().slice(0,10);
    });
    labels.forEach(d=>table[d]=data.logs[d]||{});
  } else {
    labels=[...Array(6)].map((_,i)=>{
      const d=new Date();d.setMonth(d.getMonth()-5+i);
      return d.toISOString().slice(0,7);
    });
    labels.forEach(m=>table[m]={});
    for(const [day,gs] of Object.entries(data.logs)){
      const m=day.slice(0,7);
      if(table[m]){
        for(const g in gs){
          table[m][g]=(table[m][g]||0)+gs[g];
        }
      }
    }
  }

  // æœ€å¤§å€¤
  let max=1;
  labels.forEach(l=>{
    let sum=0;
    goals.forEach(g=>sum+=(table[l][g]||0));
    max=Math.max(max,sum);
  });

  // æç”»
  labels.forEach((l,i)=>{
    let y=190;
    goals.forEach((g,gi)=>{
      const v=table[l][g]||0;
      const h=(v/max)*160;
      ctx.fillStyle=colors[gi%colors.length];
      ctx.fillRect(20+i*45,y-h,30,h);
      y-=h;
    });
    ctx.fillStyle='#000';
    ctx.fillText(mode==='day'?l.slice(5):l,15+i*45,205);
  });
}

renderHome();
</script>
</body>
</html>
