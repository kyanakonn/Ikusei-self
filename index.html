<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‡ªåˆ†ã‚’è‚²ã¦ã‚‹è‚²æˆã‚¢ãƒ—ãƒª</title>
<style>
body{margin:0;font-family:system-ui;background:#f4f6fb}
.card{max-width:480px;margin:auto;padding:16px}
h1{font-size:1.4rem}
button,select,input{width:100%;padding:10px;margin-top:8px}
.hidden{display:none}
.log-day{background:#fff;padding:10px;margin-top:10px;border-radius:8px}
.goal{background:#eef;padding:8px;margin-top:6px;border-radius:6px}
canvas{background:#fff;border-radius:8px;margin-top:10px}
.code{font-size:1.4rem;font-weight:bold;text-align:center;letter-spacing:4px}
</style>
</head>
<body>
<div class="card">

<!-- åˆæœŸ / ãƒ­ã‚°ã‚¤ãƒ³é¸æŠ -->
<div id="entry">
<h1>ã‚ˆã†ã“ã</h1>
<button onclick="newAccount()">æ–°ã—ãå§‹ã‚ã‚‹</button>
<button onclick="showLogin()">å¼•ãç¶™ãã‚³ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<!-- æ–°è¦ä½œæˆ -->
<div id="setup" class="hidden">
<h1>åˆæœŸè¨­å®š</h1>
<input id="nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
<button onclick="saveUser()">é–‹å§‹</button>
</div>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
<div id="login" class="hidden">
<h1>ãƒ­ã‚°ã‚¤ãƒ³</h1>
<input id="loginCode" placeholder="å¼•ãç¶™ãã‚³ãƒ¼ãƒ‰">
<button onclick="loginWithCode()">ãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<!-- ç›®æ¨™ç®¡ç† -->
<div id="goalScreen" class="hidden">
<h1>ç›®æ¨™ç®¡ç†</h1>
<input id="goalInput" placeholder="æ–°ã—ã„ç›®æ¨™">
<button onclick="addGoal()">ç›®æ¨™è¿½åŠ </button>
<div id="goalList"></div>
<button onclick="goMain()">å‹‰å¼·ã¸</button>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ -->
<div id="main" class="hidden">
<h1 id="welcome"></h1>
<p>å¼•ãç¶™ãã‚³ãƒ¼ãƒ‰</p>
<div class="code" id="myCode"></div>
<select id="subject">
<option>è‹±èª</option><option>æ•°å­¦</option><option>å›½èª</option><option>ç†ç§‘</option><option>ç¤¾ä¼š</option>
</select>
<div>æ™‚é–“: <span id="time">0</span> ç§’</div>
<button onclick="start()">START</button>
<button onclick="stop()">STOP</button>
<button onclick="showLogs()">è¨˜éŒ²</button>
<button onclick="showGraph()">ã‚°ãƒ©ãƒ•</button>
</div>

<!-- ãƒ­ã‚° -->
<div id="logs" class="hidden">
<h1>æ—¥åˆ¥ãƒ­ã‚°</h1>
<div id="streak"></div>
<div id="logList"></div>
<button onclick="backMain()">æˆ»ã‚‹</button>
</div>

<!-- ã‚°ãƒ©ãƒ• -->
<div id="graph" class="hidden">
<h1>ã‚°ãƒ©ãƒ•</h1>
<select id="graphMode" onchange="drawGraph()">
<option value="day">æ—¥åˆ¥ï¼ˆ7æ—¥ï¼‰</option>
<option value="month">æœˆåˆ¥</option>
</select>
<canvas id="chart" width="340" height="220"></canvas>
<button onclick="backMainFromGraph()">æˆ»ã‚‹</button>
</div>
</div>

<script>
let timer,sec=0;

function generateCode(){return Math.random().toString(36).substring(2,8).toUpperCase()}

function getAll(){return JSON.parse(localStorage.getItem('accounts'))||{}}
function saveAll(a){localStorage.setItem('accounts',JSON.stringify(a))}
function getCurrent(){return localStorage.getItem('currentCode')}

function newAccount(){entry.classList.add('hidden');setup.classList.remove('hidden')}
function showLogin(){entry.classList.add('hidden');login.classList.remove('hidden')}

function saveUser(){const name=nickname.value.trim();if(!name)return;const all=getAll();let code=generateCode();while(all[code])code=generateCode();all[code]={name,goals:[],logs:{}};saveAll(all);localStorage.setItem('currentCode',code);init()}

function loginWithCode(){const code=loginCode.value.trim().toUpperCase();const all=getAll();if(!all[code])return alert('ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');localStorage.setItem('currentCode',code);init()}

function init(){entry.classList.add('hidden');setup.classList.add('hidden');login.classList.add('hidden');const code=getCurrent();if(!code)return entry.classList.remove('hidden');goalScreen.classList.remove('hidden');renderGoals()}

function getData(){return getAll()[getCurrent()]}
function saveData(d){const all=getAll();all[getCurrent()]=d;saveAll(all)}

function addGoal(){const d=getData();const g=goalInput.value.trim();if(!g)return;d.goals.push({text:g});saveData(d);goalInput.value='';renderGoals()}

function renderGoals(){const d=getData();goalList.innerHTML='';d.goals.forEach(g=>{const div=document.createElement('div');div.className='goal';div.textContent=g.text;goalList.appendChild(div)})}

function goMain(){goalScreen.classList.add('hidden');main.classList.remove('hidden');const d=getData();welcome.textContent=`ã‚ˆã†ã“ã ${d.name}`;myCode.textContent=getCurrent()}

function start(){sec=0;time.textContent=0;timer=setInterval(()=>{sec++;time.textContent=sec},1000)}

function stop(){clearInterval(timer);const d=getData();const day=new Date().toISOString().slice(0,10);const sub=subject.value;if(!d.logs[day])d.logs[day]={};d.logs[day][sub]=(d.logs[day][sub]||0)+sec;saveData(d);alert('ä¿å­˜ã—ã¾ã—ãŸ')}

function showLogs(){main.classList.add('hidden');logs.classList.remove('hidden');renderLogs()}

function renderLogs(){const d=getData();logList.innerHTML='';const days=Object.keys(d.logs).sort().reverse();let streakCount=0;let prev=new Date();days.forEach(day=>{const div=document.createElement('div');div.className='log-day';let html=`<strong>${day}</strong><br>`;Object.entries(d.logs[day]).forEach(([s,t])=>{html+=`${s}: ${Math.floor(t/60)}åˆ†<br>`});div.innerHTML=html;logList.appendChild(div);const diff=(prev-new Date(day))/(1000*60*60*24);if(diff<=1)streakCount++;prev=new Date(day)});streak.textContent=`ğŸ”¥ é€£ç¶š ${streakCount} æ—¥`}

function showGraph(){main.classList.add('hidden');graph.classList.remove('hidden');drawGraph()}
function backMainFromGraph(){graph.classList.add('hidden');main.classList.remove('hidden')}
function backMain(){logs.classList.add('hidden');main.classList.remove('hidden')}

function drawGraph(){const ctx=chart.getContext('2d');ctx.clearRect(0,0,340,220);const d=getData();const mode=graphMode.value;const now=new Date();let labels=[],values=[];
if(mode==='day'){for(let i=6;i>=0;i--){const date=new Date(now);date.setDate(now.getDate()-i);const key=date.toISOString().slice(0,10);labels.push(key.slice(5));let total=0;if(d.logs[key])Object.values(d.logs[key]).forEach(t=>total+=t);values.push(Math.floor(total/60))}}
else{const months={};Object.entries(d.logs).forEach(([day,subs])=>{const m=day.slice(0,7);months[m]=months[m]||0;Object.values(subs).forEach(t=>months[m]+=t)});labels=Object.keys(months);values=labels.map(l=>Math.floor(months[l]/60))}
const max=Math.max(...values,1);values.forEach((v,i)=>{const h=(v/max)*160;ctx.fillRect(30+i*40,190-h,20,h);ctx.fillText(labels[i],30+i*40,205);ctx.fillText(v+'m',30+i*40,180-h)})}

init();
</script>
</body>
</html>
